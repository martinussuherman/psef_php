<script>
  function fileNameFromUrl(url) {
    if (url == undefined) {
      return "";
    }

    let splitUrl = url.split("/");
    return splitUrl[splitUrl.length - 1];
  }

  function updateDataPermohonan(dataPermohonan) {
    dataPermohonan.straExpiry = moment(dataPermohonan.straExpiry).format("YYYY-MM-DD");
    dataPermohonan.name_straUrl = fileNameFromUrl(dataPermohonan.straUrl);
    dataPermohonan.name_suratPermohonanUrl = fileNameFromUrl(dataPermohonan.suratPermohonanUrl);
    dataPermohonan.name_prosesBisnisUrl = fileNameFromUrl(dataPermohonan.prosesBisnisUrl);
    dataPermohonan.name_dokumenApiUrl = fileNameFromUrl(dataPermohonan.dokumenApiUrl);
    dataPermohonan.name_dokumenPseUrl = fileNameFromUrl(dataPermohonan.dokumenPseUrl);
    dataPermohonan.name_spplUrl = fileNameFromUrl(dataPermohonan.spplUrl);
    dataPermohonan.name_izinLokasiUrl = fileNameFromUrl(dataPermohonan.izinLokasiUrl);
    dataPermohonan.name_imbUrl = fileNameFromUrl(dataPermohonan.imbUrl);
    dataPermohonan.name_pembayaranPnbpUrl = fileNameFromUrl(dataPermohonan.pembayaranPnbpUrl);
  }

  function viewPermohonan(id, showAjukanButton) {
    $.ajax({
      url: url_api_x + "PermohonanCurrentUser(" + id + ")",
      type: 'GET',
      beforeSend: function (xhr) {
        xhr.setRequestHeader('Authorization', 'Bearer ' + accesstoken + '');
      },
      dataType: 'json',
      success: function (dataPermohonan, textStatus, xhr) {
        $.ajax({
          url: url_api_x + "PermohonanApotek(" + id + ")",
          type: 'GET',
          beforeSend: function (xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + accesstoken + '');
          },
          dataType: 'json',
          success: function (dataApotek, textStatus, xhr) {
            $.ajax({
              url: url_api_x + "PermohonanKlinik(" + id + ")",
              type: 'GET',
              beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + accesstoken + '');
              },
              dataType: 'json',
              success: function (dataKlinik, textStatus, xhr) {
                $.ajax({
                  url: url_api_x + "PermohonanRumahSakit(" + id + ")",
                  type: 'GET',
                  beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + accesstoken + '');
                  },
                  dataType: 'json',
                  success: function (dataRumahSakit, textStatus, xhr) {
                    viewPermohonanData(
                      dataPermohonan,
                      dataApotek,
                      dataKlinik,
                      dataRumahSakit,
                      showAjukanButton)
                  },
                  error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                  }
                });
              },
              error: function (xhr, textStatus, errorThrown) {
                console.log('Error in Operation');
              }
            });
          },
          error: function (xhr, textStatus, errorThrown) {
            console.log('Error in Operation');
          }
        });
      },
      error: function (xhr, textStatus, errorThrown) {
        console.log('Error in Operation');
      }
    });
  }

  function viewPermohonanData(dataPermohonan, dataApotek, dataKlinik, dataRumahSakit, showAjukanButton) {
    let source = $("#view-data").html();
    let template = Handlebars.compile(source);
    let data = {
      data_permohonan: dataPermohonan,
      data_apotek: dataApotek,
      data_klinik: dataKlinik,
      data_rs: dataRumahSakit,
      showAjukanButton: showAjukanButton
    };

    updateDataPermohonan(data.data_permohonan);
    $('#load-data').html(template(data));

    if (dataApotek !== undefined) {
      $.each(dataApotek.value, function (index, value) {
        $(".detail-item").append(
          `<tr>
            <td>${index + 1}</td>
            <td>${value.name}</td>
            <td>${value.siaNumber}</td>
            <td>${value.apotekerName}</td>
            <td>${value.straNumber}</td>
            <td>${value.sipaNumber}</td>
            <td>${value.address}</td>
            <td>${value.provinsiName}</td>
          </tr>`);
      });
    }

    if (dataKlinik !== undefined) {
      $.each(dataKlinik.value, function (index, value) {
        $(".detail-item-klinik").append(
          `<tr>
            <td>${index + 1}</td>
            <td>${value.name}</td>
            <td>${value.apotekerName}</td>
            <td>${value.straNumber}</td>
            <td>${value.sipaNumber}</td>
            <td>${value.address}</td>
            <td>${value.provinsiName}</td>
          </tr>`);
      });
    }

    if (dataRumahSakit !== undefined) {
      $.each(dataRumahSakit.value, function (index, value) {
        $(".detail-item-rs").append(
          `<tr>
            <td>${index + 1}</td>
            <td>${value.name}</td>
            <td>${value.apotekerName}</td>
            <td>${value.straNumber}</td>
            <td>${value.sipaNumber}</td>
            <td>${value.address}</td>
            <td>${value.provinsiName}</td>
          </tr>`);
      });
    }
  }
</script>
